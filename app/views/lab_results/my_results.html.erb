<h1>My Lab Results</h1>

<div class="row">
  <div class="col-md-12">
    <% if @lab_results.any? %>
      <% @lab_results.group_by(&:test_date).each do |date, results| %>
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              Test Date: <%= date.strftime('%B %d, %Y') %>
              <small class="float-end"><%= results.first.lab.name %></small>
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <% results.each do |result| %>
                <div class="col-md-6 mb-3">
                  <div class="card">
                    <div class="card-body">
                      <h6 class="card-title"><%= result.test_name %></h6>
                      <p class="card-text">
                        <strong>Result:</strong> 
                        <span class="<%= result.notes&.include?('HIGH') || result.notes&.include?('ELEVATED') ? 'text-danger' : '' %>">
                          <%= result.result_value %> <%= result.result_unit %>
                        </span><br>
                        <strong>Reference:</strong> <%= result.reference_range %><br>
                        <% if result.notes.present? %>
                          <small class="text-muted"><%= result.notes %></small>
                        <% end %>
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      
      <!-- AI Analysis Section -->
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">AI Health Analysis</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Click the button below to run AI analysis on your lab results. This will analyze patterns across all your test results.</p>
          <%= button_to "Run AI Analysis", analyze_lab_results_path, 
              method: :post, 
              class: "btn btn-lg btn-primary",
              data: { confirm: "This will analyze your lab results using local AI. Continue?" } %>
        </div>
      </div>
      
      <!-- Summary Section -->
      <div class="card bg-light">
        <div class="card-body">
          <h5>Summary</h5>
          <p>Total Results: <%= @lab_results.count %></p>
          <p>Latest Test: <%= @lab_results.first.test_date.strftime('%B %d, %Y') %></p>
          <p>Oldest Test: <%= @lab_results.last.test_date.strftime('%B %d, %Y') %></p>
        </div>
      </div>
    <% else %>
      <div class="alert alert-info">
        <h4>No Lab Results Yet</h4>
        <p>Your lab results will appear here once they are added by healthcare providers.</p>
      </div>
    <% end %>
  </div>
</div>