<div class="container mt-5">
  <h2>Welcome, <%= current_patient.name || current_patient.email %>!</h2>
  
  <div class="row mt-4">
    <div class="col-md-6">
      <h4>My Health Data</h4>
      <div class="card">
        <div class="card-body">
          <h6 class="card-title">Lab Results</h6>
          <p class="card-text"><%= current_patient.lab_results.count %> results available</p>
          <%= link_to "View Lab Results", my_results_lab_results_path, class: "btn btn-primary btn-sm" %>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <h4>Connected Healthcare Providers</h4>
      <ul class="list-group">
        <% if current_patient.connected_organizations.any? %>
          <% current_patient.connected_organizations.each do |organization| %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <%= organization.name %>
              <span class="badge bg-success">Connected</span>
            </li>
          <% end %>
        <% else %>
          <li class="list-group-item">No healthcare providers connected yet</li>
        <% end %>
      </ul>
      
      <div class="card mt-3">
        <div class="card-body">
          <h6 class="card-title">Health Summary</h6>
          <p class="card-text">
            Latest test: <%= current_patient.lab_results.maximum(:test_date)&.strftime('%B %d, %Y') || 'None' %><br>
            Total results: <%= current_patient.lab_results.count %>
          </p>
          <% if current_patient.lab_results.any? %>
            <% latest_abnormal = current_patient.lab_results.where("notes LIKE ? OR notes LIKE ?", "%HIGH%", "%ELEVATED%").order(test_date: :desc).first %>
            <% if latest_abnormal %>
              <div class="alert alert-warning">
                <strong>⚠️ Attention:</strong> Recent abnormal result in <%= latest_abnormal.test_name %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="mt-5">
    <h4>Pending Requests</h4>
    <ul class="list-group">
      <% if @pending_requests.present? %>
        <% @pending_requests.each do |request| %>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><%= request.company.name %> - Requested Access</span>
            <div>
              <button class="btn btn-sm btn-success" onclick="approveRequest('<%= request.id %>')">Approve</button>
              <button class="btn btn-sm btn-danger" onclick="denyRequest('<%= request.id %>')">Deny</button>
            </div>
          </li>
        <% end %>
      <% else %>
        <li class="list-group-item">No pending requests!</li>
      <% end %>
    </ul>
  </div>
</div>

<script>
  function approveRequest(requestId) {
    fetch(`/data_requests/${requestId}/approve`, {
      method: 'POST',
      headers: { 'X-CSRF-Token': '<%= form_authenticity_token %>' }
    }).then(() => alert('Request approved!'));
  }

  function denyRequest(requestId) {
    fetch(`/data_requests/${requestId}/deny`, {
      method: 'POST',
      headers: { 'X-CSRF-Token': '<%= form_authenticity_token %>' }
    }).then(() => alert('Request denied!'));
  }

  function revokeAccess(orgId) {
    fetch(`/organizations/${orgId}/revoke`, {
      method: 'DELETE',
      headers: { 'X-CSRF-Token': '<%= form_authenticity_token %>' }
    }).then(() => alert('Access revoked!'));
  }
</script>
